{% extends 'users/base.html' %}

{% block title %}Создать рекламацию - Marketing Doors{% endblock %}

{% block content %}
<div class="min-h-screen py-8 px-4">
    <div class="max-w-5xl mx-auto">
        <!-- Заголовок страницы -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Создать рекламацию</h1>
            <p class="text-sm text-gray-600 mt-1">Заполните все обязательные поля, отмеченные <span class="text-red-500">*</span></p>
        </div>

        <!-- Сообщения -->
        {% if messages %}
            {% for message in messages %}
                <div class="mb-6 {% if message.tags == 'error' %}bg-red-50 border-l-4 border-red-500 text-red-700{% else %}bg-green-50 border-l-4 border-green-500 text-green-700{% endif %} p-4 rounded-lg animate-fadeIn" role="alert">
                    <p class="font-medium">{{ message }}</p>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Форма -->
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Назначение -->
            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Назначение</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% if show_recipient %}
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Получатель <span class="text-red-500">*</span>
                        </label>
                        <select name="recipient" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                            <option value="">Выберите получателя</option>
                            {% for recipient in recipients %}
                                <option value="{{ recipient.id }}">{{ recipient.get_full_name|default:recipient.username }} ({{ recipient.get_role_display }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div class="md:col-span-2">
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <p class="text-sm text-blue-700">
                                <strong>Получатель:</strong> Автоматически назначается сервис-менеджер
                            </p>
                        </div>
                    </div>
                    {% endif %}

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Менеджер заказа <span class="text-red-500">*</span>
                        </label>
                        <select name="manager" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                            <option value="">Выберите менеджера</option>
                            {% for manager in managers %}
                                <option value="{{ manager.id }}">{{ manager.get_full_name|default:manager.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Производство и причина -->
            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Производство</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Производственная площадка <span class="text-red-500">*</span>
                        </label>
                        <select name="production_site" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                            <option value="">Выберите площадку</option>
                            {% for site in production_sites %}
                                <option value="{{ site.id }}">{{ site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Причина рекламации <span class="text-red-500">*</span>
                        </label>
                        <select name="reason" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                            <option value="">Выберите причину</option>
                            {% for reason in reasons %}
                                <option value="{{ reason.id }}">{{ reason.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Информация о заказе и клиенте -->
            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Информация о заказе и клиенте</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Номер заказа <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="order_number" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Например: ORD-12345">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Наименование клиента <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="client_name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="ООО Компания">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Адрес <span class="text-red-500">*</span>
                        </label>
                        <textarea name="address" required rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Полный адрес установки"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Контактное лицо <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="contact_person" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Иван Иванов">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Телефон контактного лица <span class="text-red-500">*</span>
                        </label>
                        <input type="tel" name="contact_phone" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="+7XXXXXXXXXX">
                    </div>
                </div>
            </div>

            <!-- Описание проблемы -->
            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Описание проблемы</h2>
                <textarea name="problem_description" required rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Подробно опишите проблему..."></textarea>
            </div>

            <!-- Бракованные изделия -->
            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Бракованные изделия</h2>
                    <button type="button" onclick="addProduct()" class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors flex items-center">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Добавить изделие
                    </button>
                </div>
                <div id="products-container" class="space-y-4">
                    <!-- Первое изделие по умолчанию -->
                    <div class="product-item border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">Изделие #1</h3>
                            <button type="button" onclick="removeProduct(this)" class="text-red-600 hover:text-red-700">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Наименование</label>
                                <input type="text" name="product_name[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Название изделия">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Размер</label>
                                <input type="text" name="product_size[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Размеры">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Открывание</label>
                                <input type="text" name="product_opening[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Тип открывания">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Описание проблемы</label>
                                <input type="text" name="product_description[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Описание дефекта">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вложения и документы -->
            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Вложения и документы</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Фото/Видео/Документы
                        </label>
                        <input type="file" name="attachments" multiple accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx" class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100">
                        <p class="text-xs text-gray-500 mt-2">Загружаются без сжатия. Можно выбрать несколько файлов.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Ссылка на пакет документов
                        </label>
                        <input type="url" name="document_package_link" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="https://...">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Коммерческое предложение (КП)
                        </label>
                        <input type="file" name="commercial_offer" accept=".pdf,.doc,.docx,.xls,.xlsx" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>
            </div>

            <!-- Кнопки -->
            <div class="flex justify-end space-x-4">
                <a href="{% url 'projects:complaint_list' %}" class="px-8 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors font-medium">
                    Отмена
                </a>
                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-primary-600 to-cyan-600 text-white rounded-xl hover:from-primary-700 hover:to-cyan-700 transition-colors font-medium shadow-lg">
                    Создать рекламацию
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let productCounter = 1;

function addProduct() {
    productCounter++;
    const container = document.getElementById('products-container');
    const productHTML = `
        <div class="product-item border border-gray-200 rounded-xl p-4 animate-fadeIn">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-700">Изделие #${productCounter}</h3>
                <button type="button" onclick="removeProduct(this)" class="text-red-600 hover:text-red-700">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Наименование</label>
                    <input type="text" name="product_name[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Название изделия">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Размер</label>
                    <input type="text" name="product_size[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Размеры">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Открывание</label>
                    <input type="text" name="product_opening[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Тип открывания">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Описание проблемы</label>
                    <input type="text" name="product_description[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Описание дефекта">
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', productHTML);
}

function removeProduct(button) {
    const productsContainer = document.getElementById('products-container');
    if (productsContainer.children.length > 1) {
        button.closest('.product-item').remove();
        updateProductNumbers();
    } else {
        alert('Должно быть хотя бы одно изделие');
    }
}

function updateProductNumbers() {
    const products = document.querySelectorAll('.product-item');
    products.forEach((product, index) => {
        product.querySelector('h3').textContent = `Изделие #${index + 1}`;
    });
    productCounter = products.length;
}
</script>
{% endblock %}

