{% extends 'users/base.html' %}
{% load static %}

{% block title %}Редактирование рекламации #{{ complaint.id }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-10">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 animate-fadeIn">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Редактирование рекламации</h1>
                <p class="mt-1 text-sm text-gray-600">#{{ complaint.id }} • {{ complaint.order_number }}</p>
            </div>
            <div class="flex items-center space-x-3">
                <a href="{% url 'projects:complaint_detail' complaint.id %}"
                   class="inline-flex items-center px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    К карточке рекламации
                </a>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}

            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-gray-100 p-6 md:p-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Назначение</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Тип рекламации</label>
                        {{ form.complaint_type }}
                        {% if form.complaint_type.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.complaint_type.errors.0 }}</p>
                        {% else %}
                            <p class="mt-1 text-xs text-gray-500">{{ form.complaint_type.help_text }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Получатель (СМ)</label>
                        {{ form.recipient }}
                        {% if form.recipient.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.recipient.errors.0 }}</p>
                        {% else %}
                            <p class="mt-1 text-xs text-gray-500">{{ form.recipient.help_text }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Менеджер заказа</label>
                        {{ form.manager }}
                        {% if form.manager.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.manager.errors.0 }}</p>
                        {% else %}
                            <p class="mt-1 text-xs text-gray-500">{{ form.manager.help_text }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-gray-100 p-6 md:p-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Основная информация</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Производственная площадка</label>
                        {{ form.production_site }}
                        {% if form.production_site.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.production_site.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Причина рекламации</label>
                        {{ form.reason }}
                        {% if form.reason.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.reason.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Номер заказа</label>
                        {{ form.order_number }}
                        {% if form.order_number.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.order_number.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Наименование клиента</label>
                        {{ form.client_name }}
                        {% if form.client_name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.client_name.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Адрес</label>
                        {{ form.address }}
                        {% if form.address.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.address.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Контактное лицо</label>
                        {{ form.contact_person }}
                        {% if form.contact_person.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.contact_person.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                        {{ form.contact_phone }}
                        {% if form.contact_phone.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.contact_phone.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Дополнительная информация</label>
                        {{ form.additional_info }}
                        {% if form.additional_info.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.additional_info.errors.0 }}</p>
                        {% else %}
                            <p class="mt-1 text-xs text-gray-500">Необязательное поле для любых дополнительных деталей по рекламации.</p>
                        {% endif %}
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Комментарий менеджеру/монтажнику</label>
                        {{ form.assignee_comment }}
                        {% if form.assignee_comment.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.assignee_comment.errors.0 }}</p>
                        {% else %}
                            <p class="mt-1 text-xs text-gray-500">Сообщите исполнителю, на что обратить внимание, какие документы собрать или что сказать клиенту. Поле необязательное.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-gray-100 p-6 md:p-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Документы и материалы</h2>
                <div class="grid grid-cols-1 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ссылка на пакет документов</label>
                        {{ form.document_package_link }}
                        {% if form.document_package_link.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.document_package_link.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Существующие вложения -->
                    {% if complaint.attachments.all %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Существующие вложения</label>
                        <div class="space-y-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            {% for attachment in complaint.attachments.all %}
                            {% if attachment.attachment_type != 'commercial_offer' %}
                            <div class="flex items-center justify-between p-2 bg-white rounded border border-gray-200">
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <div class="flex-shrink-0">
                                        {% if attachment.attachment_type == 'photo' %}
                                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                        {% elif attachment.attachment_type == 'video' %}
                                            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                            </svg>
                                        {% else %}
                                            <svg class="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <a href="{{ attachment.file.url }}" target="_blank" class="text-sm font-medium text-primary-600 hover:text-primary-700 truncate block">
                                            {{ attachment.file.name|slice:"20:" }}
                                        </a>
                                        <p class="text-xs text-gray-500">{{ attachment.get_attachment_type_display }} • {{ attachment.file_size }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Вы можете добавить дополнительные файлы ниже.</p>
                    </div>
                    {% endif %}

                    <!-- Новые вложения -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Фото/Видео/Документы</label>
                        <input type="file" id="attachments-input" name="attachments" multiple accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx" class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100" onchange="handleAttachmentsChange(this)">
                        <p class="text-xs text-gray-500 mt-2">Загружаются без сжатия. Можно выбрать несколько файлов.</p>
                        
                        <!-- Список прикрепленных файлов -->
                        <div id="attachments-list" class="mt-3 space-y-2"></div>
                    </div>

                    <!-- Существующие КП -->
                    {% regroup complaint.attachments.all by attachment_type as attachments_by_type %}
                    {% for attachment_type_group in attachments_by_type %}
                    {% if attachment_type_group.grouper == 'commercial_offer' %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Существующие коммерческие предложения</label>
                        <div class="space-y-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            {% for attachment in attachment_type_group.list %}
                            <div class="flex items-center justify-between p-2 bg-white rounded border border-blue-200">
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <svg class="h-6 w-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <div class="flex-1 min-w-0">
                                        <a href="{{ attachment.file.url }}" target="_blank" class="text-sm font-medium text-primary-600 hover:text-primary-700 truncate block">
                                            КП #{{ forloop.counter }}
                                        </a>
                                        <p class="text-xs text-gray-500">{{ attachment.file_size }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Вы можете добавить дополнительные КП ниже.</p>
                    </div>
                    {% endif %}
                    {% endfor %}

                    <!-- Старое поле КП (оставляем для обратной совместимости) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Коммерческое предложение (файл) - устаревшее поле</label>
                        {% if complaint.commercial_offer %}
                            <p class="text-sm text-gray-600 mb-2">
                                Текущий файл: 
                                <a href="{{ complaint.commercial_offer.url }}" target="_blank" class="text-primary-600 underline">
                                    {{ complaint.commercial_offer.name }}
                                </a>
                            </p>
                        {% endif %}
                        {{ form.commercial_offer }}
                        {% if form.commercial_offer.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.commercial_offer.errors.0 }}</p>
                        {% else %}
                            <p class="mt-1 text-xs text-gray-500">Можно загрузить новый файл. Чтобы удалить текущий, отметьте чекбокс «Очистить». Рекомендуется использовать поле "Новые коммерческие предложения" ниже.</p>
                        {% endif %}
                    </div>

                    <!-- Новые КП -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Новые коммерческие предложения (КП)</label>
                        <input type="file" id="commercial-offers-input" name="commercial_offers" multiple accept=".pdf,.doc,.docx,.xls,.xlsx" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="handleCommercialOffersChange(this)">
                        <p class="text-xs text-gray-500 mt-2">Можно выбрать несколько файлов КП.</p>
                        
                        <!-- Список КП -->
                        <div id="commercial-offers-list" class="mt-3 space-y-2"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Комментарий к коммерческому предложению</label>
                        {{ form.commercial_offer_text }}
                        {% if form.commercial_offer_text.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.commercial_offer_text.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <a href="{% url 'projects:complaint_detail' complaint.id %}"
                   class="inline-flex items-center justify-center px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors">
                    Отмена
                </a>
                <button type="submit"
                        class="inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-primary-600 to-cyan-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Сохранить изменения
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// ========== УПРАВЛЕНИЕ ФАЙЛАМИ ==========

// Массивы для хранения выбранных файлов
let attachmentsFiles = [];
let commercialOffersFiles = [];

// Обработка изменения вложений
function handleAttachmentsChange(input) {
    const newFiles = Array.from(input.files);
    attachmentsFiles = [...attachmentsFiles, ...newFiles];
    updateAttachmentsList();
    input.value = ''; // Сбрасываем input для возможности добавить еще файлы
}

// Обработка изменения КП
function handleCommercialOffersChange(input) {
    const newFiles = Array.from(input.files);
    commercialOffersFiles = [...commercialOffersFiles, ...newFiles];
    updateCommercialOffersList();
    input.value = ''; // Сбрасываем input для возможности добавить еще файлы
}

// Удаление вложения
function removeAttachment(index) {
    attachmentsFiles.splice(index, 1);
    updateAttachmentsList();
}

// Удаление КП
function removeCommercialOffer(index) {
    commercialOffersFiles.splice(index, 1);
    updateCommercialOffersList();
}

// Обновление списка вложений
function updateAttachmentsList() {
    const container = document.getElementById('attachments-list');
    
    if (attachmentsFiles.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = attachmentsFiles.map((file, index) => {
        const fileSize = formatFileSize(file.size);
        const fileType = getFileType(file.name);
        const icon = getFileIcon(fileType);
        
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 animate-fadeIn">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <div class="flex-shrink-0">
                        ${icon}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(file.name)}</p>
                        <p class="text-xs text-gray-500">${fileSize} • ${fileType}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" onclick="previewAttachment(${index})"
                            class="flex items-center px-3 py-2 text-sm font-medium text-primary-600 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors"
                            title="Открыть файл">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14m-10 4h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Открыть
                    </button>
                    <button type="button" onclick="removeAttachment(${index})" 
                            class="ml-2 flex-shrink-0 text-red-600 hover:text-red-700 transition-colors"
                            title="Удалить файл">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Обновление списка КП
function updateCommercialOffersList() {
    const container = document.getElementById('commercial-offers-list');
    
    if (commercialOffersFiles.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = commercialOffersFiles.map((file, index) => {
        const fileSize = formatFileSize(file.size);
        
        return `
            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200 animate-fadeIn">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(file.name)}</p>
                        <p class="text-xs text-gray-500">${fileSize} • КП #${index + 1}</p>
                    </div>
                </div>
                <button type="button" onclick="removeCommercialOffer(${index})" 
                        class="ml-3 flex-shrink-0 text-red-600 hover:text-red-700 transition-colors"
                        title="Удалить файл">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
        `;
    }).join('');
}

// Форматирование размера файла
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Б';
    const k = 1024;
    const sizes = ['Б', 'КБ', 'МБ', 'ГБ'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Определение типа файла
function getFileType(filename) {
    const ext = filename.toLowerCase().split('.').pop();
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'Фото';
    if (['mp4', 'avi', 'mov', 'wmv', 'flv'].includes(ext)) return 'Видео';
    if (['pdf'].includes(ext)) return 'PDF';
    if (['doc', 'docx'].includes(ext)) return 'Word';
    if (['xls', 'xlsx'].includes(ext)) return 'Excel';
    return 'Документ';
}

// Получение иконки для типа файла
function getFileIcon(fileType) {
    if (fileType === 'Фото') {
        return `<svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>`;
    }
    if (fileType === 'Видео') {
        return `<svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>`;
    }
    return `<svg class="h-8 w-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
    </svg>`;
}

// Предпросмотр вложения
function previewAttachment(index) {
    const file = attachmentsFiles[index];
    if (!file) {
        return;
    }
    const fileURL = URL.createObjectURL(file);
    const newTab = window.open(fileURL, '_blank');

    if (!newTab) {
        alert('Не удалось открыть файл. Разрешите всплывающие окна в браузере.');
        URL.revokeObjectURL(fileURL);
        return;
    }

    newTab.onload = () => {
        URL.revokeObjectURL(fileURL);
    };
}

// Функция для экранирования HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Обновление input'ов перед отправкой формы
document.querySelector('form').addEventListener('submit', function(e) {
    // Создаем новый DataTransfer для обновления файлов
    const attachmentsInput = document.getElementById('attachments-input');
    const commercialOffersInput = document.getElementById('commercial-offers-input');
    
    // Обновляем вложения
    if (attachmentsFiles.length > 0) {
        const dtAttachments = new DataTransfer();
        attachmentsFiles.forEach(file => dtAttachments.items.add(file));
        attachmentsInput.files = dtAttachments.files;
        attachmentsInput.name = 'attachments';
    }
    
    // Обновляем КП
    if (commercialOffersFiles.length > 0) {
        const dtCommercial = new DataTransfer();
        commercialOffersFiles.forEach(file => dtCommercial.items.add(file));
        commercialOffersInput.files = dtCommercial.files;
        commercialOffersInput.name = 'commercial_offers';
    }
});
</script>
{% endblock %}

