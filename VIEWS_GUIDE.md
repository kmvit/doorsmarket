# Руководство по Views и шаблонам

## Обзор созданных страниц

### 1. Обработка рекламации СМ (`complaint_process.html`)

**URL:** `/complaints/<id>/process/`  
**Доступ:** Только для Service Manager и Complaint Department  
**Назначение:** Обработка рекламаций сервис-менеджером

**Функционал:**
- Выбор типа рекламации (Монтажник/Менеджер/Фабрика)
- Одобрение выполненной работы
- Планирование монтажа с назначением монтажника и даты

**Действия:**
- `set_type_installer` - Установить тип "Монтажник"
- `set_type_manager` - Установить тип "Менеджер"
- `set_type_factory` - Установить тип "Фабрика"
- `approve` - Одобрить выполненную работу
- `plan_installation` - Запланировать монтаж

---

### 2. Планирование монтажа (`installer_planning.html`)

**URL:** `/complaints/installer/planning/`  
**Доступ:** Только для Installer  
**Назначение:** Назначение дат монтажа монтажником

**Функционал:**
- Просмотр рекламаций, ожидающих планирования
- Модальное окно для назначения даты и времени монтажа
- Автоматическое обновление статуса после планирования

**Статусы рекламаций:**
- `waiting_installer_date` - Ожидает дату от монтажника
- `needs_planning` - Нужно запланировать

---

### 3. Завершение работы монтажником (`installer_complete.html`)

**URL:** `/complaints/<id>/complete/`  
**Доступ:** Только для Installer (назначенного на эту рекламацию)  
**Назначение:** Отметка о завершении монтажных работ

**Функционал:**
- Просмотр деталей рекламации
- Список бракованных изделий
- Вложения (фото, видео, документы)
- Подтверждение качественного выполнения работ

**Действие:**
- POST запрос - Отметить работу как выполненную

---

### 4. Управление производством (`manager_production.html`)

**URL:** `/complaints/manager/production/`  
**Доступ:** Только для Manager  
**Назначение:** Управление производством и планирование отгрузок

**Функционал:**
- Просмотр рекламаций менеджера
- Запуск производства с указанием срока готовности
- Отметка товара как готового на складе
- Планирование отгрузки

**Действия:**
- `start_production` - Запустить производство (требует production_deadline)
- `mark_on_warehouse` - Отметить товар как готовый на складе
- `plan_shipping` - Запланировать отгрузку (требует shipping_date)

**Статусы:**
- `in_progress` - В работе (можно запустить производство)
- `in_production` - В производстве (можно отметить готовность)
- `on_warehouse` - На складе (можно запланировать отгрузку)
- `shipping_planned` - Отгрузка запланирована

---

### 5. Фабричные рекламации ОР (`or_factory_complaints.html`)

**URL:** `/complaints/or/factory/`  
**Доступ:** Только для Complaint Department (ОР)  
**Назначение:** Работа с рекламациями, связанными с фабрикой

**Функционал:**
- Статистика по фабричным рекламациям
- Добавление ответа фабрики с коммерческим предложением
- Установка срока согласования с клиентом
- Фиксация согласия клиента

**Действия:**
- `factory_responded` - Получен ответ фабрики (требует commercial_offer, agreement_deadline)
- `client_agreed` - Клиент согласен с КП

**Статусы:**
- `waiting_factory_response` - Ожидает ответа фабрики
- `waiting_factory_response_overdue` - Просрочен ответ фабрики
- `waiting_client_agreement` - Ожидает согласия клиента
- `waiting_client_agreement_overdue` - Просрочено согласие клиента
- `client_agreed` - Клиент согласен

**Статистика:**
- Ожидают ответа
- Ожидают согласия
- Согласовано
- Просрочено

---

## Общие компоненты

### Модальные окна

Все страницы используют модальные окна для ввода данных с:
- Затемнением фона
- Закрытием по клику вне окна
- Кнопкой закрытия (X)
- Валидацией форм

### Уведомления

При каждом действии создаются уведомления для соответствующих ролей через метод `_create_notification()`.

### Безопасность

- Все views защищены `@login_required`
- Проверка роли пользователя перед доступом к функционалу
- Проверка прав на выполнение действий

---

## Навигация

Доступ к новым страницам осуществляется через:
1. Основное меню (для ролей с доступом)
2. Карточки рекламаций (кнопки действий)
3. Детальная страница рекламации

---

## Примеры использования

### Процесс обработки рекламации от монтажника:

1. СМ открывает `/complaints/<id>/process/`
2. Выбирает тип "Монтажник"
3. Назначает монтажника и дату
4. Монтажник видит задачу в `/complaints/installer/planning/`
5. Назначает точную дату монтажа
6. После выполнения переходит в `/complaints/<id>/complete/`
7. Отмечает работу как выполненную
8. СМ одобряет выполнение в `/complaints/<id>/process/`

### Процесс обработки рекламации от менеджера:

1. СМ открывает `/complaints/<id>/process/`
2. Выбирает тип "Менеджер"
3. Менеджер видит рекламацию в `/complaints/manager/production/`
4. Запускает производство с указанием срока
5. Отмечает готовность товара на складе
6. Планирует отгрузку
7. Рекламация появляется в реестре на отгрузку

### Процесс обработки фабричной рекламации:

1. СМ открывает `/complaints/<id>/process/`
2. Выбирает тип "Фабрика"
3. ОР видит рекламацию в `/complaints/or/factory/`
4. Добавляет ответ фабрики и КП
5. Устанавливает срок согласования с клиентом
6. Отмечает согласие клиента
7. Менеджер запускает производство

---

## Технические детали

### Формат дат

- `datetime-local` для планирования монтажа
- `date` для производства и отгрузки

### CSRF защита

Все формы содержат `{% csrf_token %}`

### Обработка ошибок

Используется Django messages framework:
- `messages.success()` - Успешные операции
- `messages.error()` - Ошибки и валидация

---

## Расширение функционала

Для добавления новых действий:

1. Добавьте метод в модель `Complaint`
2. Создайте обработчик в соответствующем view
3. Добавьте кнопку/форму в шаблон
4. Обновите документацию

